<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Preferences</title>

  <script type="text/javascript">
    const CLEVERTAP_ACCOUNT_ID = "WRK-W46-ZR7Z";
  </script>

  <!-- CleverTap JS -->
  <script type="text/javascript">
    var clevertap = {
      event: [],
      profile: [],
      account: [],
      onUserLogin: [],
      notifications: [],
      privacy: [],
      region: "eu1" /* CHANGE IF REQUIRED */
    };

    clevertap.account.push({ id: CLEVERTAP_ACCOUNT_ID });
    clevertap.privacy.push({ optOut: false });

    (function () {
      var wzrk = document.createElement("script");
      wzrk.type = "text/javascript";
      wzrk.async = true;
      wzrk.src = "https://d2r1yp2w7bby2u.cloudfront.net/js/clevertap.min.js";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(wzrk, s);
    })();
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      max-width: 600px;
      margin: auto;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 16px;
    }
    button {
      margin-right: 10px;
      padding: 10px 16px;
      cursor: pointer;
    }
    #unsubscribe-groups {
      margin-top: 16px;
    }
  </style>
</head>

<body>
  <h2>Manage Email Preferences</h2>

  <label>Email address</label>
  <input
    type="text"
    id="email"
    placeholder="Fetching email..."
  />

  <div id="unsubscribe-groups" style="display:none;"></div>

  <br />

  <button onclick="unsubscribe()">Unsubscribe All</button>
  <button onclick="resubscribe()">Resubscribe</button>
  <button onclick="changeSubscriptionGroups()">Update Groups</button>

  <script type="text/javascript">
    var isReEncode = false;
    var withGroups = true;
    var fetchedEmail = null;

    window.onload = function () {
      if (window.$WZRK_WR) {
        $WZRK_WR.getEmail(isReEncode, withGroups);
      } else {
        console.error("CleverTap SDK not loaded");
      }
    };

    /* Called when email is fetched */
    function wzrk_email_fetched(emailStr, profile) {
      fetchedEmail = emailStr || "";
      document.getElementById("email").value = fetchedEmail;

      if (profile && profile.groups && profile.groups.length > 0) {
        $WZRK_WR.setSubscriptionGroups(profile.groups);
        renderGroups(profile.groups);
      }
    }

    function wzrk_email_fetched_failed(error) {
      alert(error.error || "Failed to fetch email");
    }

    /* Called after unsubscribe / resubscribe */
    function wzrk_email_subscription(status) {
      var statusLabel = status === 0 ? "unsubscribed" : "subscribed";
      alert("You've been " + statusLabel);
    }

    /* Ensure edited email is used */
    function syncEditedEmail() {
      var email = document.getElementById("email").value.trim();

      if (!email) {
        alert("Please enter a valid email address");
        return false;
      }

      /* Override email used by CleverTap */
      $WZRK_WR.setEmail(email);
      return true;
    }

    function unsubscribe() {
      if (!syncEditedEmail()) return;
      $WZRK_WR.unSubEmail(isReEncode);
    }

    function resubscribe() {
      if (!syncEditedEmail()) return;
      $WZRK_WR.subEmail(isReEncode);
    }

    function renderGroups(groups) {
      var container = document.getElementById("unsubscribe-groups");
      container.style.display = "block";
      container.innerHTML = "";

      groups.forEach(function (group) {
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = group.isUnsubscribed;
        checkbox.name = group.name;
        checkbox.className = "ct-unsub-group-input-item";

        var label = document.createElement("label");
        label.innerText = " Unsubscribe from " + group.name;

        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      });
    }

    function changeSubscriptionGroups() {
      if (!syncEditedEmail()) return;

      var updatedGroups = [];
      var elements = document.getElementsByClassName("ct-unsub-group-input-item");

      for (var i = 0; i < elements.length; i++) {
        updatedGroups.push({
          name: elements
